# ะััะตั ะฟะพ ัะบะทะฐะผะตะฝะฐัะธะพะฝะฝะพะน ัะฐะฑะพัะต: Flask API ั CI/CD

**ะัะฟะพะปะฝะธะป:** ะะตัะตะปััะบะธะน ะะฐะฒะตะป  
**ะะฐัะฐ ะฒัะฟะพะปะฝะตะฝะธั:** 10 ะธัะฝั 2025  
**ะกะตัะฒะตั:** Ubuntu 24.04.1 LTS (37.9.53.237)

- **ะะตะฟะพะทะธัะพัะธะน ั ะบะพะดะพะผ:** https://github.com/PavelMetelsky/HW-lesta/blob/master/Final/report.md
- **Production endpoint:** http://37.9.53.237:5001/results
- **ะะฐะฑะพัะฐั ะดะธัะตะบัะพัะธั:** ~/flask-api-exam

## ะะฟะธัะฐะฝะธะต ะทะฐะดะฐะฝะธั

ะะฐะทัะฐะฑะพัะบะฐ REST API ะฟัะธะปะพะถะตะฝะธั ะฝะฐ Flask ั PostgreSQL ะฑะฐะทะพะน ะดะฐะฝะฝัั ะธ ะฝะฐัััะพะนะบะฐ CI/CD pipeline ัะตัะตะท Jenkins ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ัะฐะทะฒะตัััะฒะฐะฝะธั ะฝะฐ production ัะตัะฒะตัะต.

### ะคัะฝะบัะธะพะฝะฐะปัะฝัะต ััะตะฑะพะฒะฐะฝะธั:
- โ POST /submit - ัะพััะฐะฝะตะฝะธะต ะดะฐะฝะฝัั (name, score) ะฒ PostgreSQL
- โ GET /results - ะฟะพะปััะตะฝะธะต ะฒัะตั ะทะฐะฟะธัะตะน ะธะท ะะ
- โ GET /ping - health check endpoint

## 1. ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
~/flask-api-exam/
โโโ app/
โ   โโโ __init__.py       # ะะฝะธัะธะฐะปะธะทะฐัะธั Flask ะฟัะธะปะพะถะตะฝะธั
โ   โโโ models.py         # ะะพะดะตะปั ะดะฐะฝะฝัั (Result)
โ   โโโ routes.py         # API endpoints
โโโ run.py                # ะขะพัะบะฐ ะฒัะพะดะฐ ะฟัะธะปะพะถะตะฝะธั
โโโ requirements.txt      # Python ะทะฐะฒะธัะธะผะพััะธ
โโโ Dockerfile           # Multi-stage ัะฑะพัะบะฐ
โโโ docker-compose.yml   # ะัะบะตัััะฐัะธั ะบะพะฝัะตะนะฝะตัะพะฒ
โโโ .env                 # ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
โโโ .env.example         # ะัะธะผะตั ะฟะตัะตะผะตะฝะฝัั
โโโ Jenkinsfile          # CI/CD pipeline
โโโ README.md            # ะะพะบัะผะตะฝัะฐัะธั
```

## 2. ะะตะฐะปะธะทะฐัะธั Flask ะฟัะธะปะพะถะตะฝะธั

### ะะฐะทะฐ ะดะฐะฝะฝัั PostgreSQL

**ะขะฐะฑะปะธัะฐ results:**
| ะะพะปะต | ะขะธะฟ | ะะฟะธัะฐะฝะธะต |
|------|-----|----------|
| id | INTEGER | ะะตัะฒะธัะฝัะน ะบะปัั, ะฐะฒัะพะธะฝะบัะตะผะตะฝั |
| name | VARCHAR(100) | ะะผั ะฟะพะปัะทะพะฒะฐัะตะปั |
| score | INTEGER | ะะพะปะธัะตััะฒะพ ะฑะฐะปะปะพะฒ |
| timestamp | DATETIME | ะัะตะผั ัะพะทะดะฐะฝะธั ะทะฐะฟะธัะธ (ะฐะฒัะพะผะฐัะธัะตัะบะธ) |

### API Endpoints

#### POST /submit
```bash
curl -X POST http://localhost:5001/submit \
  -H "Content-Type: application/json" \
  -d '{"name": "Kirill", "score": 88}'

# Response:
{
  "message": "Data saved successfully",
  "id": 1
}
```

#### GET /ping
```bash
curl http://localhost:5001/ping

# Response:
{"status": "ok"}
```

#### GET /results
```bash
curl http://localhost:5001/results

# Response:
[
  {
    "id": 1,
    "name": "Kirill",
    "score": 88,
    "timestamp": "2025-06-10T10:25:43"
  },
  {
    "id": 2,
    "name": "Roman",
    "score": 92,
    "timestamp": "2025-06-10T10:30:10"
  }
]
```

## 3. Docker ะบะพะฝัะธะณััะฐัะธั

### Multi-stage Dockerfile

```dockerfile
FROM python:3.10-slim

# ะกะธััะตะผะฝัะต ะทะฐะฒะธัะธะผะพััะธ ะดะปั PostgreSQL
RUN apt-get update && apt-get install -y \
    gcc python3-dev libpq-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .
EXPOSE 5000

# Production ัะตัะฒะตั Gunicorn
CMD ["gunicorn", "--bind", "0.0.0.0:5000", "--workers", "2", "run:app"]
```

### Docker Compose

- **web**: Flask ะฟัะธะปะพะถะตะฝะธะต ะฝะฐ ะฟะพััั 5001
- **db**: PostgreSQL 16 Alpine
- **ะกะตัะธ**: ะธะทะพะปะธัะพะฒะฐะฝะฝะฐั flask-network
- **Volumes**: ะฟะพััะพัะฝะฝะพะต ััะฐะฝะธะปะธัะต ะดะปั ะะ
- **Health checks**: ะฟัะพะฒะตัะบะฐ ะณะพัะพะฒะฝะพััะธ PostgreSQL

## 4. CI/CD Pipeline (Jenkins)

### ะกัะฐะดะธะธ pipeline:

1. **Checkout** - ะบะปะพะฝะธัะพะฒะฐะฝะธะต ัะตะฟะพะทะธัะพัะธั ะธะท Git
2. **Build** - ัะฑะพัะบะฐ Docker ะพะฑัะฐะทะฐ ะฟัะธะปะพะถะตะฝะธั
3. **Test/Lint** - ะฟัะพะฒะตัะบะฐ ะบะพะดะฐ ั ะฟะพะผะพััั flake8
4. **Push** - ัะพััะฐะฝะตะฝะธะต ะพะฑัะฐะทะฐ ะดะปั ะดะตะฟะปะพั
5. **Deploy** - ะฐะฒัะพะผะฐัะธัะตัะบะพะต ัะฐะทะฒะตัััะฒะฐะฝะธะต ะฝะฐ production

### Jenkinsfile ััััะบัััะฐ:

```groovy
pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = 'flask-api-exam'
        REMOTE_HOST = '37.9.53.237'
        REMOTE_USER = 'ubuntu'
        REMOTE_DIR = '/home/ubuntu/flask-api-prod'
    }
    
    stages {
        stage('Checkout') { ... }
        stage('Build') { ... }
        stage('Test/Lint') { ... }
        stage('Push') { ... }
        stage('Deploy') { ... }
    }
}
```

## 5. ะะฐะทะฒะตัััะฒะฐะฝะธะต ะธ ัะตััะธัะพะฒะฐะฝะธะต

### ะะพะบะฐะปัะฝัะน ะทะฐะฟััะบ:

```bash
cd ~/flask-api-exam
docker-compose up -d

# ะัะพะฒะตัะบะฐ ััะฐัััะฐ
docker-compose ps

# NAME              COMMAND                  SERVICE   STATUS    PORTS
# flask_api         "gunicorn --bind 0..."   web       running   0.0.0.0:5001->5000/tcp
# flask_postgres    "docker-entrypoint..."   db        running   0.0.0.0:5433->5432/tcp
```

### Production ะดะตะฟะปะพะน:

```bash
./deploy.sh

# ะะตะทัะปััะฐั:
๐ ะะฐัะธะฝะฐะตะผ ะดะตะฟะปะพะน ะฝะฐ production...
๐ฆ ะกะฑะพัะบะฐ Docker ะพะฑัะฐะทะฐ...
๐พ ะกะพััะฐะฝะตะฝะธะต ะพะฑัะฐะทะฐ...
๐ ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะธ ะฝะฐ ัะตัะฒะตัะต...
๐ค ะะพะฟะธัะพะฒะฐะฝะธะต ัะฐะนะปะพะฒ...
๐ ะะฐะทะฒะตัััะฒะฐะฝะธะต ะฝะฐ ัะตัะฒะตัะต...
โ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ!
```

### ะะตะทัะปััะฐัั ัะตััะธัะพะฒะฐะฝะธั API:

![alt text](image.png)

## 6. ะััะธัะตะบัััะฐ ัะตัะตะฝะธั

```
โโโโโโโโโโโโโโโโโโโ
โ     Client      โ
โโโโโโโโโโฌโโโโโโโโโ
         โ HTTP/5001
โโโโโโโโโโผโโโโโโโโโ
โ Ubuntu Server   โ
โ 37.9.53.237     โ
โโโโโโโโโโโโโโโโโโโค
โ Docker Engine   โ
โโโโโโโโโโโโโโโโโโโค
โ โโโโโโโโโโโโโโโ โ
โ โ  Flask API  โ โ :5001โ:5000
โ โ  (Gunicorn) โ โ
โ โโโโโโโโฌโโโโโโโ โ
โ        โ        โ
โ โโโโโโโโผโโโโโโโ โ
โ โ PostgreSQL  โ โ :5433โ:5432
โ โ   16 Alpine โ โ
โ โโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโ

CI/CD Pipeline:
GitHub โ Jenkins โ Build โ Test โ Deploy โ Production
```

## 7. ะัะพะฑะตะฝะฝะพััะธ ัะตะฐะปะธะทะฐัะธะธ

1. **ะะทะผะตะฝะตะฝะธะต ะฟะพััะฐ**: ะัะฟะพะปัะทะพะฒะฐะฝ ะฟะพัั 5001 ะฒะผะตััะพ 5000 ะธะท-ะทะฐ ะบะพะฝัะปะธะบัะฐ(ะดะปั ะดะพะผะฐัะบะธ 10)
2. **Health checks**: PostgreSQL ะฟัะพะฒะตััะตััั ะฟะตัะตะด ะทะฐะฟััะบะพะผ Flask
3. **Multi-stage build**: ะะฟัะธะผะธะทะธัะพะฒะฐะฝ ัะฐะทะผะตั Docker ะพะฑัะฐะทะฐ
4. **Gunicorn**: Production-ready WSGI ัะตัะฒะตั
5. **Environment variables**: ะะพะฝัะธะณััะฐัะธั ัะตัะตะท .env ัะฐะนะป
6. **Auto-restart**: ะะพะฝัะตะนะฝะตัั ะฟะตัะตะทะฐะฟััะบะฐัััั ะฟัะธ ัะฑะพะต

## ะะตะทัะปััะฐัั

- โ API ะดะพัััะฟะฝะพ ะฟะพ ะฐะดัะตัั: http://37.9.53.237:5001/results